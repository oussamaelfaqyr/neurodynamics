<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Quest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-bg-850: #1a202c;
        }
        .bg-gray-850 {
            background-color: var(--color-bg-850);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3B82F6;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        input[type=range]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #3B82F6;
            border-radius: 50%;
            cursor: pointer;
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% {
                transform: translateY(-25%);
                animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
            }
            50% {
                transform: translateY(0);
                animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
            }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-xl overflow-hidden">
            
            <!-- Header -->
            <div class="p-6 md:p-8 text-center bg-gray-850">
                <h1 class="text-3xl md:text-4xl font-extrabold text-blue-400">ML Quest <i class="fas fa-brain ml-2"></i></h1>
                <p class="mt-2 text-gray-400 text-sm">Help A.I. bot Sparky learn by completing the machine learning pipeline!</p>
            </div>

            <!-- Progress Bar -->
            <div class="px-6 md:px-8 pt-4">
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-500 ease-in-out" style="width: 0%;"></div>
                </div>
                <div class="text-center mt-2 text-sm text-gray-400">Time Left: <span id="timer">--</span>s</div>
            </div>

            <!-- Story Wrapper -->
            <div id="game-container" class="p-6 md:p-8">

                <!-- Step 0: Intro -->
                <div id="step-intro" class="bg-gray-700 p-6 rounded-xl shadow-inner text-center">
                    <i class="fas fa-robot text-6xl text-blue-400 mb-4 animate-bounce"></i>
                    <h2 class="text-2xl font-bold mb-2">Welcome to ML Quest!</h2>
                    <p class="text-gray-300 mb-4">Sparky's main goal is to help a city's public transit system predict bus ticket prices. This is a big problem! To solve it, we'll use machine learning to build a "brain" for Sparky that can look at information like passenger numbers and bus routes and figure out the price on its own. The entire process you're about to go through, from cleaning data to making a final prediction, is called the **machine learning pipeline**.</p>
                    <p class="text-gray-300 mb-6">Your mission is to guide Sparky, a little robot, through the fundamental steps of machine learning. From messy data to smart predictions, you'll be his mentor. Each completed challenge will unlock the next stage of his learning journey.</p>
                    <button id="start-quest-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 shadow-lg">
                        Start Quest <i class="fas fa-rocket ml-2"></i>
                    </button>
                </div>

                <!-- Step 1: Data Collection -->
                <div id="step-data-collection" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner">
                    <p class="text-gray-300 mb-2">Every machine learning project begins with data. But not all data is useful! We need to find the right ingredients, called **features**, that will help our model make good predictions. A feature is simply a piece of information that helps describe something. For example, the number of passengers or the route name could be good features to predict a bus ticket's price.</p>
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fas fa-database text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">1. Data Collection & Understanding</h2>
                    </div>
                    <p class="text-gray-300 mb-4">Sparky has a messy dataset of bus prices. Help him find the important features by selecting the useful columns below.</p>
                    <div id="data-collection-columns" class="bg-gray-800 p-4 rounded-lg">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <!-- Columns will be injected by JavaScript -->
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="check-columns-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                            Submit <i class="fas fa-check ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: Data Cleaning -->
                <div id="step-data-cleaning" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner">
                    <p class="text-gray-300 mb-2">Now that we have our features, we have to make sure the data is clean. Data in the real world is often messy! It can have missing values (like "N/A"), typos, or other errors. A model can't learn from bad data, so we have to fix it. We can either remove the bad entries or try to fill in the missing information.</p>
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fas fa-broom text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">2. Data Cleaning</h2>
                    </div>
                    <p class="text-gray-300 mb-4">Uh oh! Some data is missing. How should Sparky handle the empty 'Passenger Count' entries?</p>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <table class="w-full text-sm text-left rtl:text-right text-gray-400 rounded-lg overflow-hidden">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Bus ID</th>
                                    <th scope="col" class="px-6 py-3">Route</th>
                                    <th scope="col" class="px-6 py-3">Passenger Count</th>
                                </tr>
                            </thead>
                            <tbody id="data-cleaning-table">
                                <!-- Data will be injected by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button id="clean-avg-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                                Fill with Average <i class="fas fa-calculator ml-2"></i>
                            </button>
                            <button id="clean-drop-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                                Drop Rows <i class="fas fa-trash ml-2"></i>
                            </button>
                            <button id="clean-zero-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                                Fill with 0 <i class="fas fa-circle-notch ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Data Transformation -->
                <div id="step-data-transformation" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner">
                    <p class="text-gray-300 mb-2">Our model needs numbers to learn from, but some of our features are text! This is where **data transformation** comes in. We need to convert categories like "Route A-101" into a number. This process is called **encoding** and it's a critical step to prepare data for a model.</p>
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fas fa-exchange-alt text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">3. Data Transformation</h2>
                    </div>
                    <p class="text-gray-300 mb-4">Bus routes are text, but models only understand numbers! Turn the 'Route' categories into numerical values.</p>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div id="data-transformation-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
                            <!-- Routes will be injected by JavaScript -->
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="check-transformation-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                            Encode <i class="fas fa-arrow-right-arrow-left ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 4: Feature Scaling -->
                <div id="step-feature-scaling" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner">
                    <p class="text-gray-300 mb-2">Now we have numbers, but they're on different scales. For example, a bus price might be in the thousands, while a route number is a single digit. This can make the model "think" that the bigger number is more important, which isn't always true. **Feature scaling** fixes this by normalizing all the numbers to a common range, like 0 to 1.</p>
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fas fa-arrows-alt-h text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">4. Feature Scaling</h2>
                    </div>
                    <p class="text-gray-300 mb-4">Bus prices are very large, while route numbers are small. These different scales can confuse a model! Put them on the same scale (0-1) using a slider.</p>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <span class="text-lg font-semibold">Price (1000-10000)</span>
                            <span id="scaling-value-display" class="text-blue-400 text-2xl">0.50</span>
                        </div>
                        <input id="scaling-slider" type="range" min="0" max="1" step="0.01" value="0.5" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="check-scaling-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                            Scale <i class="fas fa-sliders-h ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 5: Train/Test Split -->
                <div id="step-train-test-split" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner">
                    <p class="text-gray-300 mb-2">Imagine a student studying for a test. They need to practice on some problems but also save some problems to test their knowledge later. This is what **train/test split** is for. We use most of our data to train the model, but we set aside a small portion to test it. This ensures our model hasn't just memorized the data and can actually make good predictions on new, unseen data.</p>
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fas fa-cut text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">5. Train / Test Split</h2>
                    </div>
                    <p class="text-gray-300 mb-4">To make sure Sparky's model can predict *new* data, we need to split our dataset. Drag the data blocks into the right buckets.</p>
                    <div class="flex flex-col md:flex-row gap-4">
                        <div id="train-box" class="flex-1 p-6 border-4 border-dashed border-gray-600 rounded-xl flex flex-col items-center justify-center text-center transition-colors"
                             ondrop="handleDrop(event, 'training')" ondragover="event.preventDefault()">
                            <i class="fas fa-graduation-cap text-3xl mb-2 text-gray-400"></i>
                            <p class="text-lg font-bold">Training Data (80%)</p>
                            <p class="text-sm text-gray-400 mt-1"><span id="training-count">0</span> / 10 items</p>
                        </div>
                        <div id="test-box" class="flex-1 p-6 border-4 border-dashed border-gray-600 rounded-xl flex flex-col items-center justify-center text-center transition-colors"
                             ondrop="handleDrop(event, 'testing')" ondragover="event.preventDefault()">
                            <i class="fas fa-microscope text-3xl mb-2 text-gray-400"></i>
                            <p class="text-lg font-bold">Testing Data (20%)</p>
                            <p class="text-sm text-gray-400 mt-1"><span id="testing-count">0</span> / 10 items</p>
                        </div>
                    </div>
                    <div id="data-blocks-grid" class="mt-6 grid grid-cols-4 md:grid-cols-8 gap-2">
                        <!-- Data blocks will be injected by JavaScript -->
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="check-split-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                            Split <i class="fas fa-check ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 6: Model Training -->
                <div id="step-model-training" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner">
                    <p class="text-gray-300 mb-2">Our data is finally ready! Now we can start **model training**. A model is like a student who learns from the data to find patterns. We'll give Sparky's model the training data and it will learn to connect features like 'passenger count' and 'route number' to a specific 'price'. For simple tasks like this, a simple model is usually the best place to start!</p>
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fas fa-cogs text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">6. Model Training</h2>
                    </div>
                    <p class="text-gray-300 mb-4">Now it's time to teach Sparky! Pick the best model to predict bus prices based on the simple features you selected.</p>
                    <div id="model-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Models will be injected by JavaScript -->
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="check-model-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                            Train Model <i class="fas fa-play ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 7: Evaluation -->
                <div id="step-evaluation" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner">
                    <p class="text-gray-300 mb-2">The model has been trained. But how do we know if it did a good job? This is where **evaluation** comes in. We use the testing data we saved earlier to see how well the model predicts new prices. We measure its performance using a **metric**, which is just a fancy word for a way to score its performance. The simplest metric is to check how often it got the price exactly right.</p>
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fas fa-chart-line text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">7. Evaluation</h2>
                    </div>
                    <p class="text-gray-300 mb-4">How well did Sparky's model do? Pick the best metric to show its performance on predicting bus prices.</p>
                    <div id="evaluation-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Metrics will be injected by JavaScript -->
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="check-metric-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                            Evaluate <i class="fas fa-poll ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 8: Prediction -->
                <div id="step-prediction" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner">
                    <div class="flex items-center mb-4 text-blue-400">
                        <i class="fas fa-magic text-2xl mr-2"></i>
                        <h2 class="text-xl font-bold">8. Prediction Challenge!</h2>
                    </div>
                    <p class="text-gray-300 mb-4">Great job! The model you chose is a simple **Linear Regression** model. Its rule for predicting prices is: <strong>Price = (Number of Passengers * 50) + 100</strong>. Your challenge is to use this formula to predict the price yourself!</p>
                    <div class="bg-gray-800 p-6 rounded-lg flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex-1 w-full md:w-auto">
                            <label class="text-gray-300 font-semibold mb-2 block">Number of Passengers:</label>
                            <div id="passenger-count-display" class="w-full p-3 rounded-md bg-gray-700 text-white font-bold text-lg text-center">---</div>
                        </div>
                        <div class="flex-1 w-full md:w-auto mt-4 md:mt-0">
                            <label for="predicted-price-input" class="text-gray-300 font-semibold mb-2 block">Your Predicted Price:</label>
                            <input id="predicted-price-input" type="number" class="w-full p-3 rounded-md bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your prediction">
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="predict-price-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                            Predict <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 9: Final Score -->
                <div id="step-final" class="hidden bg-gray-700 p-6 rounded-xl shadow-inner text-center">
                    <i class="fas fa-medal text-6xl text-yellow-400 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2">ML Quest Complete!</h2>
                    <p class="text-gray-300 mb-6">You successfully guided Sparky through the entire pipeline. Here is your final score!</p>
                    <div class="text-4xl font-extrabold mb-2 text-blue-400"><span id="final-score">0</span> pts</div>
                    <div class="text-xl font-semibold text-gray-300 mb-6"><span id="final-notation"></span></div>
                    
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Challenge Results</h3>
                        <div id="challenge-results-list" class="flex flex-col items-center space-y-2">
                            <!-- Results will be injected by JavaScript -->
                        </div>
                    </div>

                    <button id="play-again-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-full transition-transform transform hover:scale-105 shadow-lg mt-8">
                        Play Again <i class="fas fa-redo ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                currentStep: 'intro',
                score: 0,
                answers: [], // Stores 1 for correct, 0 for incorrect
                timeLimit: 60, // seconds
                timeLeft: 0,
                timerInterval: null,
                selectedColumns: new Set(),
                selectedModel: null,
                selectedMetric: null,
                split: {
                    data: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                    training: [],
                    testing: []
                },
                gameData: {
                    columns: [
                        { name: 'Bus ID', icon: 'fa-id-card', useful: false },
                        { name: 'Route', icon: 'fa-road', useful: true },
                        { name: 'Passenger Count', icon: 'fa-users', useful: true },
                        { name: 'Driver Name', icon: 'fa-user', useful: false },
                        { name: 'Price', icon: 'fa-dollar-sign', useful: true },
                        { name: 'Date', icon: 'fa-calendar', useful: false },
                        { name: 'Engine Size', icon: 'fa-engine', useful: false },
                        { name: 'Ticket Type', icon: 'fa-ticket', useful: false },
                    ],
                    cleaning: {
                        data: [
                            { id: 1, route: 'A-101', passengers: 30 },
                            { id: 2, route: 'B-202', passengers: 45 },
                            { id: 3, route: 'C-303', passengers: 'N/A' },
                            { id: 4, route: 'A-101', passengers: 55 },
                            { id: 5, route: 'D-404', passengers: 'N/A' },
                            { id: 6, route: 'C-303', passengers: 20 },
                        ]
                    },
                    transformation: {
                        routes: ['A-101', 'B-202', 'C-303', 'D-404']
                    },
                    models: [
                        { name: 'Linear Regression', icon: 'fa-chart-simple', description: 'Simple straight line model.' },
                        { name: 'Decision Tree', icon: 'fa-tree', description: 'Complex, branching logic model.' },
                        { name: 'Neural Network', icon: 'fa-microchip', description: 'Advanced, interconnected layers.' },
                    ],
                    evaluation: [
                        { name: 'Accuracy', icon: 'fa-bullseye', description: 'How often the model is correct.' },
                        { name: 'Error Rate', icon: 'fa-triangle-exclamation', description: 'How often the model is wrong.' },
                        { name: 'Confusion Matrix', icon: 'fa-table', description: 'Detailed breakdown of correct and incorrect predictions.' },
                    ]
                },
                challenge8PassengerCount: null
            };

            const elements = {
                steps: {
                    'intro': document.getElementById('step-intro'),
                    'data-collection': document.getElementById('step-data-collection'),
                    'data-cleaning': document.getElementById('step-data-cleaning'),
                    'data-transformation': document.getElementById('step-data-transformation'),
                    'feature-scaling': document.getElementById('step-feature-scaling'),
                    'train-test-split': document.getElementById('step-train-test-split'),
                    'model-training': document.getElementById('step-model-training'),
                    'evaluation': document.getElementById('step-evaluation'),
                    'prediction': document.getElementById('step-prediction'),
                    'final': document.getElementById('step-final')
                },
                progressBar: document.getElementById('progress-bar'),
                timer: document.getElementById('timer'),
                finalScore: document.getElementById('final-score'),
                finalNotation: document.getElementById('final-notation'),
                // Buttons
                startQuestBtn: document.getElementById('start-quest-btn'),
                checkColumnsBtn: document.getElementById('check-columns-btn'),
                cleanAvgBtn: document.getElementById('clean-avg-btn'),
                cleanDropBtn: document.getElementById('clean-drop-btn'),
                cleanZeroBtn: document.getElementById('clean-zero-btn'),
                checkTransformationBtn: document.getElementById('check-transformation-btn'),
                checkScalingBtn: document.getElementById('check-scaling-btn'),
                checkSplitBtn: document.getElementById('check-split-btn'),
                checkModelBtn: document.getElementById('check-model-btn'),
                checkMetricBtn: document.getElementById('check-metric-btn'),
                predictPriceBtn: document.getElementById('predict-price-btn'),
                playAgainBtn: document.getElementById('play-again-btn'),
                // Challenge elements
                dataCollectionColumns: document.getElementById('data-collection-columns').querySelector('div'),
                dataCleaningTable: document.getElementById('data-cleaning-table'),
                dataTransformationGrid: document.getElementById('data-transformation-grid'),
                scalingSlider: document.getElementById('scaling-slider'),
                scalingValueDisplay: document.getElementById('scaling-value-display'),
                dataBlocksGrid: document.getElementById('data-blocks-grid'),
                trainingCount: document.getElementById('training-count'),
                testingCount: document.getElementById('testing-count'),
                trainBox: document.getElementById('train-box'),
                testBox: document.getElementById('test-box'),
                modelGrid: document.getElementById('model-grid'),
                evaluationGrid: document.getElementById('evaluation-grid'),
                passengerCountDisplay: document.getElementById('passenger-count-display'),
                predictedPriceInput: document.getElementById('predicted-price-input'),
                // Final Score elements
                challengeResultsList: document.getElementById('challenge-results-list')
            };

            const stepNames = ['intro', 'data-collection', 'data-cleaning', 'data-transformation', 'feature-scaling', 'train-test-split', 'model-training', 'evaluation', 'prediction', 'final'];

            // --- UI Update & Game Flow ---
            function updateUI() {
                Object.values(elements.steps).forEach(el => el.classList.add('hidden'));
                elements.steps[state.currentStep].classList.remove('hidden');

                if (state.currentStep !== 'intro' && state.currentStep !== 'final') {
                    const stepIndex = stepNames.indexOf(state.currentStep) - 1;
                    elements.progressBar.style.width = `${(stepIndex) * (100 / 8)}%`;
                } else if (state.currentStep === 'final') {
                    elements.progressBar.style.width = '100%';
                }

                if (state.currentStep === 'data-collection') renderDataCollection();
                if (state.currentStep === 'data-cleaning') renderDataCleaning();
                if (state.currentStep === 'data-transformation') renderDataTransformation();
                if (state.currentStep === 'train-test-split') renderTrainTestSplit();
                if (state.currentStep === 'model-training') renderModels();
                if (state.currentStep === 'evaluation') renderEvaluation();
                if (state.currentStep === 'prediction') renderPrediction();
                if (state.currentStep === 'final') renderFinalScore();
            }

            function startTimer() {
                clearInterval(state.timerInterval);
                state.timeLeft = state.timeLimit;
                elements.timer.textContent = state.timeLeft;
                state.timerInterval = setInterval(() => {
                    state.timeLeft--;
                    elements.timer.textContent = state.timeLeft;
                    if (state.timeLeft <= 0) {
                        clearInterval(state.timerInterval);
                        nextStep(false);
                    }
                }, 1000);
            }

            function nextStep(isCorrect) {
                clearInterval(state.timerInterval);
                state.answers.push(isCorrect ? 1 : 0);

                const nextIndex = stepNames.indexOf(state.currentStep) + 1;
                if (nextIndex < stepNames.length) {
                    state.currentStep = stepNames[nextIndex];
                    updateUI();
                    if (state.currentStep !== 'final') {
                        startTimer();
                    }
                }
            }
            
            // --- Rendering Functions ---
            function renderDataCollection() {
                elements.dataCollectionColumns.innerHTML = state.gameData.columns.map(col => `
                    <div class="flex flex-col items-center p-4 rounded-lg cursor-pointer transition-all duration-200 bg-gray-700 hover:bg-gray-600"
                         onclick="toggleColumnSelection(this, '${col.name}')">
                        <div class="w-12 h-12 flex items-center justify-center text-3xl mb-2">
                            <i class="fa-solid ${col.icon}"></i>
                        </div>
                        <span class="text-sm text-center font-semibold">${col.name}</span>
                    </div>
                `).join('');
            }
            window.toggleColumnSelection = (el, name) => {
                if (state.selectedColumns.has(name)) {
                    state.selectedColumns.delete(name);
                    el.classList.remove('bg-blue-600', 'ring-4', 'ring-blue-500', 'shadow-md');
                    el.classList.add('bg-gray-700', 'hover:bg-gray-600');
                } else {
                    state.selectedColumns.add(name);
                    el.classList.add('bg-blue-600', 'ring-4', 'ring-blue-500', 'shadow-md');
                    el.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                }
            };
            
            function renderDataCleaning() {
                elements.dataCleaningTable.innerHTML = state.gameData.cleaning.data.map(row => `
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <td class="px-6 py-4 font-medium text-white">${row.id}</td>
                        <td class="px-6 py-4">${row.route}</td>
                        <td class="px-6 py-4 text-orange-400 font-bold ${row.passengers === 'N/A' ? 'text-red-400' : ''}">
                            ${row.passengers}
                        </td>
                    </tr>
                `).join('');
            }

            function renderDataTransformation() {
                elements.dataTransformationGrid.innerHTML = state.gameData.transformation.routes.map(route => `
                    <div class="p-4 rounded-lg border-2 border-gray-600 flex flex-col items-center">
                        <span class="text-lg font-semibold">${route}</span>
                        <input type="text" data-route="${route}" class="mt-2 w-24 p-2 text-center bg-gray-700 text-white rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. 1">
                    </div>
                `).join('');
            }

            function renderTrainTestSplit() {
                elements.dataBlocksGrid.innerHTML = state.split.data.map(item => `
                    <div class="p-2 text-xs bg-blue-600 text-center rounded-md shadow-md cursor-grab active:cursor-grabbing transition-transform transform hover:scale-110"
                         draggable="true" ondragstart="handleDragStart(event, ${item})">
                        #${item}
                    </div>
                `).join('');
                elements.trainingCount.textContent = state.split.training.length;
                elements.testingCount.textContent = state.split.testing.length;
            }
            window.handleDragStart = (e, item) => {
                e.dataTransfer.setData('text/plain', item);
            };
            window.handleDrop = (e, target) => {
                const itemId = parseInt(e.dataTransfer.getData('text/plain'));
                if (target === 'training' && state.split.training.length < 8) {
                    state.split.training.push(itemId);
                } else if (target === 'testing' && state.split.testing.length < 2) {
                    state.split.testing.push(itemId);
                }
                state.split.data = state.split.data.filter(item => item !== itemId);
                renderTrainTestSplit();
            };

            function renderModels() {
                elements.modelGrid.innerHTML = state.gameData.models.map(model => `
                    <button class="p-6 rounded-xl border-2 border-gray-600 transition-colors duration-200 bg-gray-800 hover:bg-gray-700"
                            onclick="selectModel('${model.name}', this)">
                        <div class="flex flex-col items-center">
                            <div class="text-4xl mb-2"><i class="fa-solid ${model.icon}"></i></div>
                            <span class="text-lg font-bold">${model.name}</span>
                            <p class="text-sm text-gray-400 mt-1">${model.description}</p>
                        </div>
                    </button>
                `).join('');
            }
            window.selectModel = (name, el) => {
                state.selectedModel = name;
                document.querySelectorAll('#model-grid button').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'ring-4', 'ring-blue-500');
                    btn.classList.add('bg-gray-800', 'hover:bg-gray-700');
                });
                el.classList.add('bg-blue-600', 'ring-4', 'ring-blue-500');
            };

            function renderEvaluation() {
                elements.evaluationGrid.innerHTML = state.gameData.evaluation.map(metric => `
                    <button class="p-6 rounded-xl border-2 border-gray-600 transition-colors duration-200 bg-gray-800 hover:bg-gray-700"
                            onclick="selectMetric('${metric.name}', this)">
                        <div class="flex flex-col items-center">
                            <div class="text-4xl mb-2"><i class="fa-solid ${metric.icon}"></i></div>
                            <span class="text-lg font-bold">${metric.name}</span>
                            <p class="text-sm text-gray-400 mt-1">${metric.description}</p>
                        </div>
                    </button>
                `).join('');
            }
            window.selectMetric = (name, el) => {
                state.selectedMetric = name;
                document.querySelectorAll('#evaluation-grid button').forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'ring-4', 'ring-blue-500');
                    btn.classList.add('bg-gray-800', 'hover:bg-gray-700');
                });
                el.classList.add('bg-blue-600', 'ring-4', 'ring-blue-500');
            };

            function renderPrediction() {
                state.challenge8PassengerCount = Math.floor(Math.random() * 20) + 1; // Random number from 1 to 20
                elements.passengerCountDisplay.textContent = state.challenge8PassengerCount;
                elements.predictedPriceInput.value = '';
                elements.predictedPriceInput.classList.remove('text-red-400');
                elements.predictedPriceInput.classList.add('text-white');
            }

            function renderFinalScore() {
                const totalCorrect = state.answers.filter(a => a === 1).length;
                const totalChallenges = 8;
                elements.finalScore.textContent = `${totalCorrect}`;
                elements.finalNotation.textContent = `${totalCorrect} / ${totalChallenges} Correct`;

                const challengeNames = [
                    '1. Data Collection', '2. Data Cleaning', '3. Data Transformation',
                    '4. Feature Scaling', '5. Train/Test Split', '6. Model Training',
                    '7. Evaluation', '8. Prediction'
                ];
                
                elements.challengeResultsList.innerHTML = state.answers.map((answer, index) => {
                    const icon = answer === 1 ? 'fa-check text-green-400' : 'fa-xmark text-red-400';
                    const text = answer === 1 ? 'Correct' : 'Incorrect';
                    return `
                        <div class="flex items-center space-x-2 text-lg">
                            <i class="fas ${icon}"></i>
                            <span>${challengeNames[index]}: ${text}</span>
                        </div>
                    `;
                }).join('');
            }

            // --- Event Listeners and Game Logic ---
            elements.startQuestBtn.addEventListener('click', () => {
                state.currentStep = 'data-collection';
                state.score = 0;
                state.answers = []; // Reset answers
                updateUI();
                startTimer();
            });

            elements.playAgainBtn.addEventListener('click', () => {
                state.currentStep = 'intro';
                state.selectedColumns = new Set();
                state.selectedModel = null;
                state.selectedMetric = null;
                state.split.data = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                state.split.training = [];
                state.split.testing = [];
                elements.predictedPriceInput.value = '';
                updateUI();
            });
            
            elements.checkColumnsBtn.addEventListener('click', () => {
                const usefulSelected = state.gameData.columns.filter(c => c.useful).every(c => state.selectedColumns.has(c.name));
                const uselessNotSelected = state.gameData.columns.filter(c => !c.useful).every(c => !state.selectedColumns.has(c.name));
                if (usefulSelected && uselessNotSelected) {
                    nextStep(true);
                } else {
                    nextStep(false);
                }
            });

            elements.cleanAvgBtn.addEventListener('click', () => nextStep(true));
            elements.cleanDropBtn.addEventListener('click', () => nextStep(false));
            elements.cleanZeroBtn.addEventListener('click', () => nextStep(false));

            elements.checkTransformationBtn.addEventListener('click', () => {
                const inputs = document.querySelectorAll('#data-transformation-grid input');
                const values = Array.from(inputs).map(input => input.value);
                const uniqueValues = new Set(values);
                if (uniqueValues.size === 4 && !values.includes('')) {
                    nextStep(true);
                } else {
                    nextStep(false);
                }
            });

            elements.scalingSlider.addEventListener('input', () => {
                elements.scalingValueDisplay.textContent = parseFloat(elements.scalingSlider.value).toFixed(2);
            });
            elements.checkScalingBtn.addEventListener('click', () => {
                const value = parseFloat(elements.scalingSlider.value);
                if (value > 0.9 && value < 1.1) {
                    nextStep(true);
                } else {
                    nextStep(false);
                }
            });
            
            elements.checkSplitBtn.addEventListener('click', () => {
                if (state.split.training.length === 8 && state.split.testing.length === 2) {
                    nextStep(true);
                } else {
                    nextStep(false);
                }
            });

            elements.checkModelBtn.addEventListener('click', () => {
                if (state.selectedModel === 'Linear Regression') {
                    nextStep(true);
                } else {
                    nextStep(false);
                }
            });

            elements.checkMetricBtn.addEventListener('click', () => {
                if (state.selectedMetric === 'Accuracy') {
                    nextStep(true);
                } else {
                    nextStep(false);
                }
            });

            elements.predictPriceBtn.addEventListener('click', () => {
                const userPrediction = parseFloat(elements.predictedPriceInput.value);
                const correctPrice = (state.challenge8PassengerCount * 50) + 100;
                const isCorrect = userPrediction === correctPrice;
                nextStep(isCorrect);
            });

            // Initial UI rendering
            updateUI();
        });
    </script>
</body>
</html>
